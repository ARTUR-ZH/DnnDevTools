<div class="dnnDevTools-toolbar">
    <div class="dnnDevTools-toolbarMenu">
        <button type="button" id="dnnDevTools-overviewButton" class="dnnDevTools-overviewButton" title="Show overview">
            <span class="dnnDevTools-wrenchIcon dnnDevTools-icon24x24"></span>
        </button>
        <button type="button" id="dnnDevTools-settingsButton" class="dnnDevTools-settingsButton">
            <span class="dnnDevTools-cogIcon dnnDevTools-icon16x16"></span>
        </button>
    </div>

    <div id="dnnDevTools-mailNote" class="dnnDevTools-mailNote dnnDevTools-panel dnnDevTools-bgColorGrey dnnDevTools-hidden">
        <p class="dnnDevTools-copySmall">
            <span id="dnnDevTools-mailNoteDate"></span>
        </p>
        <p class="dnnDevTools-copySmall">
            <span id="dnnDevTools-mailNoteSubject"></span>
        </p>
        <p class="dnnDevTools-copySmall">
            <span class="dnnDevTools-copySmall dnnDevTools-copyBold">From:</span>
            <span id="dnnDevTools-mailNoteSender"></span>
        </p>
        <p class="dnnDevTools-copySmall">
            <span class="dnnDevTools-copySmall dnnDevTools-copyBold">To:</span>
            <span id="dnnDevTools-mailNoteReciever"></span>
        </p>
    </div>
</div>

<div id="dnnDevTools-overlay" class="dnnDevTools-overlay dnnDevTools-hidden">
    <div id="dnnDevTools-overlayPanel" class="dnnDevTools-overlayPanel">
        <iframe id="dnnDevTools-overviewIframe" src="" width="100%" height="100%"></iframe>
    </div>
</div>

<script>
    (function(document, window, settings) {
        var hub = $.connection.dnnDevToolsNotificationHub,
            mailNote = {},
            mailNoteTimeoutId,
            mailNoteElement = document.getElementById('dnnDevTools-mailNote'),
            dateElement = document.getElementById('dnnDevTools-mailNoteDate'),
            subjectElement = document.getElementById('dnnDevTools-mailNoteSubject'),
            senderElement = document.getElementById('dnnDevTools-mailNoteSender'),
            recieverElement = document.getElementById('dnnDevTools-mailNoteReciever'),
            overviewButton = document.getElementById('dnnDevTools-overviewButton'),
            overlay = document.getElementById('dnnDevTools-overlay'),
            overlayPanel = document.getElementById('dnnDevTools-overlayPanel'),
            overviewIframe = document.getElementById('dnnDevTools-overviewIframe'),
            settingsButton = document.getElementById('dnnDevTools-settingsButton');

        // merge settings with default settings
        settings.mailNoteVisibleTime = settings.mailNoteVisibleTime || 3000;
        
        // initialization
        initMailNote();
        initOverlay();
        initConnection();

        function initMailNote() {
            mailNoteElement.addEventListener('click', function () {
                openOverlay(mailNote.Id);
            }, false);
        }

        function initOverlay() {
            // toggle overlay visibility on overview button click
            overviewButton.addEventListener('click', function () {
                toggleOverlay();
            }, false);

            // open settings page on settings button click
            settingsButton.addEventListener('click', function () {
                window.location.href = window.weweave.dnnDevTools.hostSettingsUrl;
            }, false);
            
            // close mail overview window when clicking outside the window panel
            overlay.addEventListener('click', function () {
                closeOverlay();
            });

            // prevent closing the mail overview window when clicking on the window panel
            overlayPanel.addEventListener('click', function (event) {
                event.stopPropagation();
            });
        }

        function initConnection() {
            // listen to mail events
            hub.client.OnEvent = function (data) {
                console.log(data.Type);
                if (data.Type === 'Mail') {
                    updateMailNote(data);
                    showMailNote();
                } else if (data.Type === 'LogMessage') {
                    // console.log(data);
                } else if (data.Type === 'DnnEvent') {
                    // console.log(data);
                }
            };

            // open connection
            $.connection.hub.start();
        }

        function toggleOverlay(id) {
            if (overlay.classList.contains('dnnDevTools-hidden')) {
                openOverlay();
            } else {
                closeOverlay();
            }
        }

        /**
         * opens the mail overlay
         * @param {string} id The mail with this id will be initially highlighted in overlay
         */
        function openOverlay(id) {
            var route = (id !== undefined) ? ('#/maildetail/' + id) : '';

            overviewIframe.src = window.weweave.dnnDevTools.baseUrl + 'Overlay.aspx' + route;
            overlay.classList.remove('dnnDevTools-hidden');

            overviewButton.classList.add('dnnDevTools-active');
        }

        function closeOverlay() {
            overviewIframe.src = '';
            overlay.classList.add('dnnDevTools-hidden');

            overviewButton.classList.remove('dnnDevTools-active');
        }

        /**
        * Populate last mail elements with new mails data
        * @param {object} data Data of mail
        */
        function updateMailNote(data) {
            mailNote = data;
            dateElement.textContent = data.Timestamp;
            subjectElement.textContent = data.Subject;
            senderElement.textContent = data.Sender;
            recieverElement.textContent = data.To;
        }

        function showMailNote() {
            // TODO check internet explorer support (http://caniuse.com/#search=classList)
            mailNoteElement.classList.remove('dnnDevTools-hidden');

            // reset timeout if another mail comes in while the last mail is still visible
            if (mailNoteTimeoutId) {
                clearTimeout(mailNoteTimeoutId);
                mailNoteTimeoutId = null;
            }

            // hide last mail after some short delay
            mailNoteTimeoutId = window.setTimeout(hideMailNote, settings.mailNoteVisibleTime);
        }

        function hideMailNote() {
            // TODO check internet explorer support (http://caniuse.com/#search=classList)
            mailNoteElement.classList.add('dnnDevTools-hidden');
        }
    }(document, window, {}));
</script>