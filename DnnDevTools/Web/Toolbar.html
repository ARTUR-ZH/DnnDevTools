<style>
    /* MDT: Mail Developer Toolbar */

    /* ATOMS */
    .dnn-mdt-checkbox {
        margin-right: 4px;
    }

    /* LAST MAIL */
    #dnn-mdt-lastMail {
        position: absolute;
        bottom: 100%;
        right: 0;
    }

    /* TEMPLATES */
    #dnn-mdt-hint {
        position: fixed;
        right: 20px;
        bottom: 20px;   
        border: 1px solid #cdcdcd;
        text-align: right;
    }

    #dnn-mdt-hint #dnn-mdt-mailOverviewButton {
        display: block;
    }

    #dnn-mdt-mailOverviewWindow {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: rgba(0, 0, 0, 0.5);
    }

    #dnn-mdt-mailOverviewPanel {
        position: fixed;
        left: 15%;
        right: 15%;
        top: 15%;
        bottom: 15%;
        background-color: #ffffff;
        padding: 30px;
    }

    /* LAYOUT */
    .dnn-mdt-panel {
        padding: 15px;
        text-align: left;
    }

    .dnn-mdt-marginBottom1 {
        margin-bottom: 14px;
    }

    .dnn-mdt-hidden {
        display: none;
    }

    /* COLORS */
    .dnn-mdt-bgColorWhite {
        background-color: #ffffff;
    }

    .dnn-mdt-bgColorGrey {
        background-color: #e5e5e5;
    }

    /* FONTS */
    .dnn-mdt-copySmall {
        font-size: 12px;
        margin-top: 0;
        margin-bottom: 0;
    }

    .dnn-mdt-copyBold {
        font-weight: bold;
    }
</style>

<div id="dnn-mdt-hint">
    <div class="dnn-mdt-panel dnn-mdt-bgColorWhite">
        <div class="dnn-mdt-marginBottom1">
            <input id="dnn-mdt-status" type="checkbox" class="dnn-mdt-checkbox" checked="checked" />
            <label for="dnn-mdt-status" class="dnn-mdt-copySmall">Enable mail catch</label>
        </div>
        <button type="button" id="dnn-mdt-mailOverviewButton">Show mail overview</button>
    </div>
    <div id="dnn-mdt-lastMail" class="dnn-mdt-panel dnn-mdt-bgColorGrey dnn-mdt-hidden">
        <p class="dnn-mdt-copySmall">
            <span id="dnn-mdt-lastMailDate"></span>
        </p>
        <p class="dnn-mdt-copySmall">
            <span id="dnn-mdt-lastMailSubject"></span>
        </p>
        <p class="dnn-mdt-copySmall">
            <span class="dnn-mdt-copySmall dnn-mdt-copyBold">From:</span>
            <span id="dnn-mdt-lastMailSender"></span>
        </p>
        <p class="dnn-mdt-copySmall">
            <span class="dnn-mdt-copySmall dnn-mdt-copyBold">To:</span>
            <span id="dnn-mdt-lastMailReciever"></span>
        </p>
    </div>
</div>

<div id="dnn-mdt-mailOverviewWindow" class="dnn-mdt-hidden">
    <div id="dnn-mdt-mailOverviewPanel">
        <iframe id="dnn-mdt-mailOverviewIframe" src="" width="100%" height="100%"></iframe>
    </div>
</div>

<script type="text/javascript">
    (function(document, window, settings) {
        // console.log("Mail catch enabled: " + window.dnnMailDev.config.enableMailCatch);

        var hub = $.connection.dnnDevToolsEventHub,
            lastMailTimeoutId,
            statusElement = document.getElementById('dnn-mdt-status'),
            lastMailElement = document.getElementById('dnn-mdt-lastMail'),
            dateElement = document.getElementById('dnn-mdt-lastMailDate'),
            subjectElement = document.getElementById('dnn-mdt-lastMailSubject'),
            senderElement = document.getElementById('dnn-mdt-lastMailSender'),
            revieverElement = document.getElementById('dnn-mdt-lastMailReciever'),
            mailOverviewButton = document.getElementById('dnn-mdt-mailOverviewButton'),
            mailOverviewWindow = document.getElementById('dnn-mdt-mailOverviewWindow'),
            mailOverviewPanel = document.getElementById('dnn-mdt-mailOverviewPanel'),
            mailOverviewIframe = document.getElementById('dnn-mdt-mailOverviewIframe');

        // merge settings with default settings
        settings.lastMailVisibleTime = settings.lastMailVisibleTime || 3000;
        
        // initialization
        initMailOverview();
        initStatusCheckbox();
        enable();

        function initMailOverview() {
            mailOverviewButton.addEventListener('click', function () {
                mailOverviewIframe.src = 'http://localhost/dnndevtools/DesktopModules/DnnDevTools/Overlay.aspx';
                mailOverviewWindow.classList.remove('dnn-mdt-hidden');
            }, false);
            
            // close mail overview window when clicking outside the window panel
            mailOverviewWindow.addEventListener('click', function () {
                mailOverviewIframe.src = '';
                mailOverviewWindow.classList.add('dnn-mdt-hidden');
            });

            // prevent closing the mail overview window when clicking on the window panel
            mailOverviewPanel.addEventListener('click', function (event) {
                event.stopPropagation();
            });
        }

        /**
        * Establishets connection to devToolsEventHub
        */
        function enable() {
            // listen to mail events
            hub.client.OnEvent = function (data) {
                updateLastEmail(data);
                showLastMail();
            };

            // open connection
            $.connection.hub.start();
        }

        function disable() {
            // TODO is there a better way to remove the callback?
            hub.client.OnEvent = null;

            // close connection
            $.connection.hub.stop();
        }

        function initStatusCheckbox() {
            statusElement.addEventListener('change', function (event) {
                if (this.checked) {
                    enable();
                } else {
                    disable();
                }
            });
        }

        /**
        * Populate last mail elements with new mails data
        * @param {object} data Data of mail
        */
        function updateLastEmail(data) {
            dateElement.textContent = data.SentOn;
            subjectElement.textContent = data.Subject;
            senderElement.textContent = data.Sender;
            revieverElement.textContent = data.To;
        }

        function showLastMail() {
            // TODO check internet explorer support (http://caniuse.com/#search=classList)
            lastMailElement.classList.remove('dnn-mdt-hidden');

            // reset timeout if another mail comes in while the last mail is still visible
            if (lastMailTimeoutId) {
                clearTimeout(lastMailTimeoutId);
                lastMailTimeoutId = null;
            }

            // hide last mail after some short delay
            lastMailTimeoutId = window.setTimeout(hideLastMail, settings.lastMailVisibleTime);
        }

        function hideLastMail() {
            // TODO check internet explorer support (http://caniuse.com/#search=classList)
            lastMailElement.classList.add('dnn-mdt-hidden');
        }
    }(document, window, {}));
</script>