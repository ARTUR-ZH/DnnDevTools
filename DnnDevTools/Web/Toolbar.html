<div id="dnn-mdt-hint">
    <div class="dnn-mdt-menu">
        <button type="button" id="dnn-mdt-mailOverviewButton" class="dnn-mdt-iconButton" title="[res:ShowMailOvierview]">
            <span class="dnn-mdt-inboxIcon dnn-mdt-icon24x24"></span>
        </button>
        <button type="button" id="dnn-mdt-settingsButton" class="dnn-mdt-settingsButton dnn-mdt-iconButton">
            <span class="dnn-mdt-cogIcon dnn-mdt-icon16x16"></span>
        </button>
    </div>

    <div id="dnn-mdt-lastMail" class="dnn-mdt-panel dnn-mdt-bgColorGrey dnn-mdt-hidden">
        <p class="dnn-mdt-copySmall">
            <span id="dnn-mdt-lastMailDate"></span>
        </p>
        <p class="dnn-mdt-copySmall">
            <span id="dnn-mdt-lastMailSubject"></span>
        </p>
        <p class="dnn-mdt-copySmall">
            <span class="dnn-mdt-copySmall dnn-mdt-copyBold">From:</span>
            <span id="dnn-mdt-lastMailSender"></span>
        </p>
        <p class="dnn-mdt-copySmall">
            <span class="dnn-mdt-copySmall dnn-mdt-copyBold">To:</span>
            <span id="dnn-mdt-lastMailReciever"></span>
        </p>
    </div>
</div>

<div id="dnn-mdt-mailOverviewWindow" class="dnn-mdt-hidden">
    <div id="dnn-mdt-mailOverviewPanel">
        <iframe id="dnn-mdt-mailOverviewIframe" src="" width="100%" height="100%"></iframe>
    </div>
</div>

<script>
    (function(document, window, settings) {
        var hub = $.connection.dnnDevToolsNotificationHub,
            lastMail = {},
            lastMailTimeoutId,
            lastMailElement = document.getElementById('dnn-mdt-lastMail'),
            dateElement = document.getElementById('dnn-mdt-lastMailDate'),
            subjectElement = document.getElementById('dnn-mdt-lastMailSubject'),
            senderElement = document.getElementById('dnn-mdt-lastMailSender'),
            recieverElement = document.getElementById('dnn-mdt-lastMailReciever'),
            mailOverviewButton = document.getElementById('dnn-mdt-mailOverviewButton'),
            mailOverviewWindow = document.getElementById('dnn-mdt-mailOverviewWindow'),
            mailOverviewPanel = document.getElementById('dnn-mdt-mailOverviewPanel'),
            mailOverviewIframe = document.getElementById('dnn-mdt-mailOverviewIframe'),
            settingsButton = document.getElementById('dnn-mdt-settingsButton');

        // merge settings with default settings
        settings.lastMailVisibleTime = settings.lastMailVisibleTime || 3000;
        
        // initialization
        initLastMail();
        initMailOverview();
        initConnection();

        function initLastMail() {
            lastMailElement.addEventListener('click', function () {
                openOverlay(lastMail.Id);
            }, false);
        }

        function initMailOverview() {
            // toggle overlay visibility on overview button click
            mailOverviewButton.addEventListener('click', function () {
                toggleOverlay();
            }, false);

            // open settings page on settings button click
            settingsButton.addEventListener('click', function () {
                window.location.href = window.dnnDevTools.hostSettingsUrl;
            }, false);
            
            // close mail overview window when clicking outside the window panel
            mailOverviewWindow.addEventListener('click', function () {
                closeOverlay();
            });

            // prevent closing the mail overview window when clicking on the window panel
            mailOverviewPanel.addEventListener('click', function (event) {
                event.stopPropagation();
            });
        }

        function initConnection() {
            // listen to mail events
            hub.client.OnEvent = function (data) {
                console.log(data.Type);
                if (data.Type === 'MailSent') {
                    updateLastEmail(data);
                    showLastMail();
                } else if (data.Type === 'LogMessage') {
                    // console.log(data);
                } else if (data.Type === 'Event') {
                    // console.log(data);
                }
            };

            // open connection
            $.connection.hub.start();
        }

        function toggleOverlay(id) {
            if (mailOverviewWindow.classList.contains('dnn-mdt-hidden')) {
                openOverlay();
            } else {
                closeOverlay();
            }
        }

        /**
         * opens the mail overlay
         * @param {string} id The mail with this id will be initially highlighted in overlay
         */
        function openOverlay(id) {
            var route = (id !== undefined) ? ('#/mail/' + id) : '';

            mailOverviewIframe.src = window.dnnDevTools.baseUrl + 'Overlay.aspx' + route;
            mailOverviewWindow.classList.remove('dnn-mdt-hidden');

            mailOverviewButton.classList.add('dnn-mdt-active');
        }

        function closeOverlay() {
            mailOverviewIframe.src = '';
            mailOverviewWindow.classList.add('dnn-mdt-hidden');

            mailOverviewButton.classList.remove('dnn-mdt-active');
        }

        /**
        * Populate last mail elements with new mails data
        * @param {object} data Data of mail
        */
        function updateLastEmail(data) {
            lastMail = data;
            dateElement.textContent = data.SentOn;
            subjectElement.textContent = data.Subject;
            senderElement.textContent = data.Sender;
            recieverElement.textContent = data.To;
        }

        function showLastMail() {
            // TODO check internet explorer support (http://caniuse.com/#search=classList)
            lastMailElement.classList.remove('dnn-mdt-hidden');

            // reset timeout if another mail comes in while the last mail is still visible
            if (lastMailTimeoutId) {
                clearTimeout(lastMailTimeoutId);
                lastMailTimeoutId = null;
            }

            // hide last mail after some short delay
            lastMailTimeoutId = window.setTimeout(hideLastMail, settings.lastMailVisibleTime);
        }

        function hideLastMail() {
            // TODO check internet explorer support (http://caniuse.com/#search=classList)
            lastMailElement.classList.add('dnn-mdt-hidden');
        }
    }(document, window, {}));
</script>