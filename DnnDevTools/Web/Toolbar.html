<div class="dnn-mdt-toolbar">
    <div class="dnn-mdt-toolbarMenu">
        <button type="button" id="dnn-mdt-overviewButton" class="dnn-mdt-overviewButton" title="Show overview">
            <span class="dnn-mdt-wrenchIcon dnn-mdt-icon24x24"></span>
        </button>
        <button type="button" id="dnn-mdt-settingsButton" class="dnn-mdt-settingsButton">
            <span class="dnn-mdt-cogIcon dnn-mdt-icon16x16"></span>
        </button>
    </div>

    <div id="dnn-mdt-mailNote" class="dnn-mdt-mailNote dnn-mdt-panel dnn-mdt-bgColorGrey dnn-mdt-hidden">
        <p class="dnn-mdt-copySmall">
            <span id="dnn-mdt-mailNoteDate"></span>
        </p>
        <p class="dnn-mdt-copySmall">
            <span id="dnn-mdt-mailNoteSubject"></span>
        </p>
        <p class="dnn-mdt-copySmall">
            <span class="dnn-mdt-copySmall dnn-mdt-copyBold">From:</span>
            <span id="dnn-mdt-mailNoteSender"></span>
        </p>
        <p class="dnn-mdt-copySmall">
            <span class="dnn-mdt-copySmall dnn-mdt-copyBold">To:</span>
            <span id="dnn-mdt-mailNoteReciever"></span>
        </p>
    </div>
</div>

<div id="dnn-mdt-overlay" class="dnn-mdt-overlay dnn-mdt-hidden">
    <div id="dnn-mdt-overlayPanel" class="dnn-mdt-overlayPanel">
        <iframe id="dnn-mdt-overviewIframe" src="" width="100%" height="100%"></iframe>
    </div>
</div>

<script>
    (function(document, window, settings) {
        var hub = $.connection.dnnDevToolsNotificationHub,
            mailNote = {},
            mailNoteTimeoutId,
            mailNoteElement = document.getElementById('dnn-mdt-mailNote'),
            dateElement = document.getElementById('dnn-mdt-mailNoteDate'),
            subjectElement = document.getElementById('dnn-mdt-mailNoteSubject'),
            senderElement = document.getElementById('dnn-mdt-mailNoteSender'),
            recieverElement = document.getElementById('dnn-mdt-mailNoteReciever'),
            overviewButton = document.getElementById('dnn-mdt-overviewButton'),
            overlay = document.getElementById('dnn-mdt-overlay'),
            overlayPanel = document.getElementById('dnn-mdt-overlayPanel'),
            overviewIframe = document.getElementById('dnn-mdt-overviewIframe'),
            settingsButton = document.getElementById('dnn-mdt-settingsButton');

        // merge settings with default settings
        settings.mailNoteVisibleTime = settings.mailNoteVisibleTime || 3000;
        
        // initialization
        initMailNote();
        initOverlay();
        initConnection();

        function initMailNote() {
            mailNoteElement.addEventListener('click', function () {
                openOverlay(mailNote.Id);
            }, false);
        }

        function initOverlay() {
            // toggle overlay visibility on overview button click
            overviewButton.addEventListener('click', function () {
                toggleOverlay();
            }, false);

            // open settings page on settings button click
            settingsButton.addEventListener('click', function () {
                window.location.href = window.weweave.dnnDevTools.hostSettingsUrl;
            }, false);
            
            // close mail overview window when clicking outside the window panel
            overlay.addEventListener('click', function () {
                closeOverlay();
            });

            // prevent closing the mail overview window when clicking on the window panel
            overlayPanel.addEventListener('click', function (event) {
                event.stopPropagation();
            });
        }

        function initConnection() {
            // listen to mail events
            hub.client.OnEvent = function (data) {
                console.log(data.Type);
                if (data.Type === 'Mail') {
                    updateMailNote(data);
                    showMailNote();
                } else if (data.Type === 'LogMessage') {
                    // console.log(data);
                } else if (data.Type === 'DnnEvent') {
                    // console.log(data);
                }
            };

            // open connection
            $.connection.hub.start();
        }

        function toggleOverlay(id) {
            if (overlay.classList.contains('dnn-mdt-hidden')) {
                openOverlay();
            } else {
                closeOverlay();
            }
        }

        /**
         * opens the mail overlay
         * @param {string} id The mail with this id will be initially highlighted in overlay
         */
        function openOverlay(id) {
            var route = (id !== undefined) ? ('#/maildetail/' + id) : '';

            overviewIframe.src = window.weweave.dnnDevTools.baseUrl + 'Overlay.aspx' + route;
            overlay.classList.remove('dnn-mdt-hidden');

            overviewButton.classList.add('dnn-mdt-active');
        }

        function closeOverlay() {
            overviewIframe.src = '';
            overlay.classList.add('dnn-mdt-hidden');

            overviewButton.classList.remove('dnn-mdt-active');
        }

        /**
        * Populate last mail elements with new mails data
        * @param {object} data Data of mail
        */
        function updateMailNote(data) {
            mailNote = data;
            dateElement.textContent = data.Timestamp;
            subjectElement.textContent = data.Subject;
            senderElement.textContent = data.Sender;
            recieverElement.textContent = data.To;
        }

        function showMailNote() {
            // TODO check internet explorer support (http://caniuse.com/#search=classList)
            mailNoteElement.classList.remove('dnn-mdt-hidden');

            // reset timeout if another mail comes in while the last mail is still visible
            if (mailNoteTimeoutId) {
                clearTimeout(mailNoteTimeoutId);
                mailNoteTimeoutId = null;
            }

            // hide last mail after some short delay
            mailNoteTimeoutId = window.setTimeout(hideMailNote, settings.mailNoteVisibleTime);
        }

        function hideMailNote() {
            // TODO check internet explorer support (http://caniuse.com/#search=classList)
            mailNoteElement.classList.add('dnn-mdt-hidden');
        }
    }(document, window, {}));
</script>