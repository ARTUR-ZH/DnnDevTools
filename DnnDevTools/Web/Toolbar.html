<style>
    /* MDT: Mail Developer Toolbar */

    /* ATOMS */
    .dnn-mdt-checkbox {
        margin-right: 4px;
    }

    .dnn-mdt-iconButton {
        display: block;
        padding: 15px;
        background-color: #00a5e1;
        border: 2px solid #ffffff;
        border-radius: 100%;
        outline: 0;
        opacity: 0.8;
    }

    .dnn-mdt-iconButton:hover {
        opacity: 1;
    }

    .dnn-mdt-iconButton.dnn-mdt-active {
        background-color: #ec3d47;
    }

    .dnn-mdt-icon24x24 {
        display: block;
        width: 24px;
        height: 24px;
        background-size: 24px 24px;
    }

    .dnn-mdt-eyeIcon {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDMyIDMyIj48cGF0aCBmaWxsPSIjZmZmZmZmIiBkPSJNMTYgMGMtOC44MzcgMC0xNiA3LjE2My0xNiAxNnM3LjE2MyAxNiAxNiAxNiAxNi03LjE2MyAxNi0xNi03LjE2My0xNi0xNi0xNnptLTUgOC44NzVsNSA1IDUtNSAyLjEyNSAyLjEyNS01IDUgNSA1LTIuMTI1IDIuMTI1LTUtNS01IDUtMi4xMjUtMi4xMjUgNS01LTUtNSAyLjEyNS0yLjEyNXoiIC8+PC9zdmc+);
    }

    .dnn-mdt-iconButton.dnn-mdt-active .dnn-mdt-eyeIcon {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDMyIDMyIj48cGF0aCBmaWxsPSIjZmZmZmZmIiBkPSJNMTYgMGMtOC44MzcgMC0xNiA3LjE2My0xNiAxNnM3LjE2MyAxNiAxNiAxNiAxNi03LjE2MyAxNi0xNi03LjE2My0xNi0xNi0xNnptNi45MDYgOC44NzVsMi4yMTkgMi4wMzEtMTIuMDYzIDEzLjI4MS02LjE4OC02LjE4OCAyLjEyNS0yLjEyNSAzLjkzOCAzLjkzOCA5Ljk2OS0xMC45Mzh6IiAvPjwvc3ZnPg==);
    }

    .dnn-mdt-inboxIcon {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDMyIDMyIj48cGF0aCBmaWxsPSIjZmZmZmZmIiBkPSJNMiAwYy0xLjEwNSAwLTIgLjg5NS0yIDJ2MjhjMCAxLjEwNS44OTUgMiAyIDJoMjZjMS4xMDUgMCAyLS44OTUgMi0ydi0yOGMwLTEuMTA1LS44OTUtMi0yLTJoLTI2em0xIDVoMjR2MTloLTdsLTIgM2gtNmwtMi0zaC03di0xOXoiLz48L3N2Zz4=);
    }

    .dnn-mdt-iconButton.dnn-mdt-active .dnn-mdt-inboxIcon {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDE2IDE2Ij48cGF0aCBmaWxsPSIjZmZmZmZmIiBkPSJNOCAwdjNoLTh2NGg4djNsOC01LTgtNXoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAgMykiIC8+PC9zdmc+);
    }

    /* MOLECULES */
    .dnn-mdt-menu > * {
        margin-bottom: 5px;
    }
    .dnn-mdt-menu > *:last-child {
        margin-bottom: 0;
    }

    /* LAST MAIL */
    #dnn-mdt-lastMail {
        position: absolute;
        bottom: 100%;
        right: 0;
        cursor: pointer;
    }
    #dnn-mdt-lastMail:hover {
        background-color: #cdcdcd;
    }

    /* TEMPLATES */
    #dnn-mdt-hint {
        position: fixed;
        right: 10px;
        bottom: 10px;
        z-index: 10002;
    }

    #dnn-mdt-mailOverviewWindow {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1003;
        background-color: rgba(0, 0, 0, 0.9);
    }

    #dnn-mdt-mailOverviewPanel {
        position: fixed;
        left: 15%;
        right: 15%;
        top: 0;
        bottom: 0;
    }

    /* LAYOUT */
    .dnn-mdt-panel {
        padding: 15px;
        text-align: left;
    }

    .dnn-mdt-marginBottom1 {
        margin-bottom: 14px;
    }

    .dnn-mdt-hidden {
        display: none;
    }

    .dnn-mdt-visuallyHidden {
        margin: -1px;
        padding: 0;
        width: 1px;
        height: 1px;
        overflow: hidden;
        clip: rect(0 0 0 0);
        clip: rect(0, 0, 0, 0);
        position: absolute;
    }
    
    /* ANIMATIONS */
    .dnn-mdt-pulseAnimation {
        animation: pulse 1.2s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.3;
        }
        100% {
            opacity: 1;
        }
    }

    /* COLORS */
    .dnn-mdt-bgColorGrey {
        background-color: #e5e5e5;
    }

    /* FONTS */
    .dnn-mdt-copySmall {
        font-size: 12px;
        margin-top: 0;
        margin-bottom: 0;
    }

    .dnn-mdt-copyBold {
        font-weight: bold;
    }
</style>

<div id="dnn-mdt-hint">
    <div class="dnn-mdt-menu">
        <button type="button" id="dnn-mdt-statusButton" class="dnn-mdt-statusButton dnn-mdt-iconButton" title="[res:EnableMailCatch]">
            <span class="dnn-mdt-eyeIcon dnn-mdt-icon24x24"></span>
        </button>
        <button type="button" id="dnn-mdt-mailOverviewButton" class="dnn-mdt-mailOverviewButton dnn-mdt-iconButton" title="[res:ShowMailOvierview]">
            <span class="dnn-mdt-inboxIcon dnn-mdt-icon24x24"></span>
        </button>
    </div>
    <div id="dnn-mdt-lastMail" class="dnn-mdt-panel dnn-mdt-bgColorGrey dnn-mdt-hidden">
        <p class="dnn-mdt-copySmall">
            <span id="dnn-mdt-lastMailDate"></span>
        </p>
        <p class="dnn-mdt-copySmall">
            <span id="dnn-mdt-lastMailSubject"></span>
        </p>
        <p class="dnn-mdt-copySmall">
            <span class="dnn-mdt-copySmall dnn-mdt-copyBold">From:</span>
            <span id="dnn-mdt-lastMailSender"></span>
        </p>
        <p class="dnn-mdt-copySmall">
            <span class="dnn-mdt-copySmall dnn-mdt-copyBold">To:</span>
            <span id="dnn-mdt-lastMailReciever"></span>
        </p>
    </div>
</div>

<div id="dnn-mdt-mailOverviewWindow" class="dnn-mdt-hidden">
    <div id="dnn-mdt-mailOverviewPanel">
        <iframe id="dnn-mdt-mailOverviewIframe" src="" width="100%" height="100%"></iframe>
    </div>
</div>

<script type="text/javascript">
    (function () {
        dnnMdtAjax = {
            put: function(url) {
                return new Promise(function(resolve, reject) {
                    var req = new XMLHttpRequest();

                    req.open('PUT', url);

                    req.setRequestHeader('requestVerificationToken', $.ServicesFramework().getAntiForgeryValue());

                    req.onload = function() {
                        if (req.status == 200) {
                            resolve(req.response);
                        }
                        else {
                            reject(Error(req.statusText));
                        }
                    };

                    req.onerror = function() {
                        reject(Error("Please check your internet connection."));
                    };

                    req.send();
                });
            }
        }
    }());

    (function(document, window, settings) {
        var hub = $.connection.dnnDevToolsNotificationHub,
            lastMail = {},
            lastMailTimeoutId,
            statusButton = document.getElementById('dnn-mdt-statusButton'),
            lastMailElement = document.getElementById('dnn-mdt-lastMail'),
            dateElement = document.getElementById('dnn-mdt-lastMailDate'),
            subjectElement = document.getElementById('dnn-mdt-lastMailSubject'),
            senderElement = document.getElementById('dnn-mdt-lastMailSender'),
            revieverElement = document.getElementById('dnn-mdt-lastMailReciever'),
            mailOverviewButton = document.getElementById('dnn-mdt-mailOverviewButton'),
            mailOverviewWindow = document.getElementById('dnn-mdt-mailOverviewWindow'),
            mailOverviewPanel = document.getElementById('dnn-mdt-mailOverviewPanel'),
            mailOverviewIframe = document.getElementById('dnn-mdt-mailOverviewIframe');

        // merge settings with default settings
        settings.lastMailVisibleTime = settings.lastMailVisibleTime || 3000;
        
        // initialization
        initLastMail();
        initMailOverview();
        initStatusButton();
        initConnection();

        function initLastMail() {
            lastMailElement.addEventListener('click', function () {
                openOverlay(lastMail.Id);
            }, false);
        }

        function initMailOverview() {
            mailOverviewButton.addEventListener('click', function () {
                toggleOverlay();
            }, false);
            
            // close mail overview window when clicking outside the window panel
            mailOverviewWindow.addEventListener('click', function () {
                closeOverlay();
            });

            // prevent closing the mail overview window when clicking on the window panel
            mailOverviewPanel.addEventListener('click', function (event) {
                event.stopPropagation();
            });
        }

        function initConnection() {
            // listen to mail events
            hub.client.OnEvent = function (data) {
                if (data.Type === 'MailSent') {
                    updateLastEmail(data);
                    showLastMail();
                } else if (data.Type === 'LogMessage') {
                    console.log(data);
                } else if (data.Type === 'Event') {
                    console.log(data);
                }
            };

            // open connection
            $.connection.hub.start();
        }

        function toggleOverlay(id) {
            if (mailOverviewWindow.classList.contains('dnn-mdt-hidden')) {
                openOverlay();
            } else {
                closeOverlay();
            }
        }

        /**
         * opens the mail overlay
         * @param {string} id The mail with this id will be initially highlighted in overlay
         */
        function openOverlay(id) {
            var search = (id !== undefined) ? '?id=' + id : '';

            mailOverviewIframe.src = window.dnnDevTools.baseUrl + 'Overlay.aspx' + search;
            mailOverviewWindow.classList.remove('dnn-mdt-hidden');

            mailOverviewButton.classList.add('dnn-mdt-active');
        }

        function closeOverlay() {
            mailOverviewIframe.src = '';
            mailOverviewWindow.classList.add('dnn-mdt-hidden');

            mailOverviewButton.classList.remove('dnn-mdt-active');
        }

        /**
        * Enables mail catch
        */
        function enable() {
            setMailCatchStatus(true);
        }

        /**
        * Disables mail catch
        */
        function disable() {
            setMailCatchStatus(false);
        }

        function setMailCatchStatus(status) {
            closeOverlay();

            statusButton.classList.add('dnn-mdt-pulseAnimation');
            
            dnnMdtAjax.put(window.dnnDevTools.baseUrl + "api/config/enableMailCatch?status=" + status).then(function (response) {
                    statusButton.classList.remove('dnn-mdt-pulseAnimation');

                    if (status) {
                        statusButton.classList.add('dnn-mdt-active');
                    } else {
                        statusButton.classList.remove('dnn-mdt-active');
                    }
                }, function (error) {
                    statusButton.classList.remove('dnn-mdt-pulseAnimation');
                    // TODO show error
                }
            );
        }

        function initStatusButton() {
            if (window.dnnDevTools.enableMailCatch) {
                statusButton.classList.add('dnn-mdt-active');
            }

            statusButton.addEventListener('click', function (event) {
                if (statusButton.classList.contains('dnn-mdt-active')) {
                    disable();
                } else {
                    enable();
                }
            }, false);
        }

        /**
        * Populate last mail elements with new mails data
        * @param {object} data Data of mail
        */
        function updateLastEmail(data) {
            lastMail = data;
            dateElement.textContent = data.SentOn;
            subjectElement.textContent = data.Subject;
            senderElement.textContent = data.Sender;
            revieverElement.textContent = data.To;
        }

        function showLastMail() {
            // TODO check internet explorer support (http://caniuse.com/#search=classList)
            lastMailElement.classList.remove('dnn-mdt-hidden');

            // reset timeout if another mail comes in while the last mail is still visible
            if (lastMailTimeoutId) {
                clearTimeout(lastMailTimeoutId);
                lastMailTimeoutId = null;
            }

            // hide last mail after some short delay
            lastMailTimeoutId = window.setTimeout(hideLastMail, settings.lastMailVisibleTime);
        }

        function hideLastMail() {
            // TODO check internet explorer support (http://caniuse.com/#search=classList)
            lastMailElement.classList.add('dnn-mdt-hidden');
        }
    }(document, window, {}));
</script>